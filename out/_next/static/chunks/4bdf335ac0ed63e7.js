(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,43413,e=>{"use strict";var t=e.i(43476),a=e.i(71645),s=e.i(7233),l=e.i(55436),r=e.i(1928),n=e.i(7486),i=e.i(88511),d=e.i(27612),c=e.i(86536),o=e.i(40160),u=e.i(31278),m=e.i(78583),x=e.i(16715),h=e.i(23945),p=e.i(3281),j=e.i(75254);let f=(0,j.default)("file-code",[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 12.5 8 15l2 2.5",key:"1tg20x"}],["path",{d:"m14 12.5 2 2.5-2 2.5",key:"yinavb"}]]);var g=e.i(94918);let N=(0,j.default)("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]);var b=e.i(15288),v=e.i(19455),y=e.i(93479),C=e.i(67489),S=e.i(84774),T=e.i(55146),w=e.i(75157),k=e.i(69457),D=e.i(10204),I=e.i(24687),_=e.i(76639),E=e.i(46696);let A=[{value:22,label:"22% - Standart"},{value:9.5,label:"9.5% - Indirimli"},{value:5,label:"5% - Kitap"},{value:0,label:"0% - Muaf"}],F=[{value:"draft",label:"Taslak"},{value:"pending",label:"Beklemede"},{value:"approved",label:"Onaylandi"},{value:"cancelled",label:"Iptal"}],P=[{value:"unpaid",label:"Odenmedi"},{value:"partial",label:"Kismi Odeme"},{value:"paid",label:"Odendi"}],R=[{id:"merkez",name:"Merkez Depo",icon:"üè≠"}];function L({open:e,onOpenChange:l,invoice:r,onSave:n}){let i=!!r,[c,o]=(0,a.useState)(""),[u,m]=(0,a.useState)(""),[x,p]=(0,a.useState)(""),[j,f]=(0,a.useState)("merkez"),[g,N]=(0,a.useState)(""),[b,S]=(0,a.useState)(""),[T,w]=(0,a.useState)("pending"),[L,M]=(0,a.useState)("unpaid"),[B,O]=(0,a.useState)(""),[H,K]=(0,a.useState)([]),[U,q]=(0,a.useState)(!1),[V,z]=(0,a.useState)([]),[G,$]=(0,a.useState)([]);(0,a.useEffect)(()=>{let e=(0,k.subscribeToRTDB)("partners",e=>{if(e){let t=e.filter(e=>e.basic?.type==="supplier"||"supplier"===e.type).map(e=>({id:e.id||e._id,name:e.basic?.name||e.name||e.companyName||"",taxNumber:e.tax?.taxId||e.financial?.vatNumber||e.taxNumber||e.ddvNumber||""})).filter(e=>e.name);t.sort((e,t)=>e.name.localeCompare(t.name)),z(t)}}),t=(0,k.subscribeToBranches)(e=>{$(e||[])});return()=>{e(),t()}},[]),(0,a.useEffect)(()=>{if(e){let e=new Date().toISOString().split("T")[0],t=new Date(Date.now()+2592e6).toISOString().split("T")[0];r?(o(r.invoiceNo||r.invoice_number||""),m(r.date||r.invoice_date||e),p(r.dueDate||r.due_date||t),f(r.branchId||r.branch_id||"merkez"),N(r.supplierId||r.supplier_id||""),S(r.supplierDdvNo||""),w(r.status||"pending"),M(r.paymentStatus||"unpaid"),O(r.notes||""),K(r.items?.map((e,t)=>({id:e.id||`item-${t}`,description:e.description||e.name||"",quantity:e.quantity||1,unitPrice:e.unitPrice||e.unit_price||0,ddvRate:e.ddvRate||e.tax_rate||22,ddvAmount:e.ddvAmount||e.tax_amount||0,total:e.total||e.line_total||0}))||[])):(o(""),m(e),p(t),f(""),N(""),S(""),w("pending"),M("unpaid"),O(""),K([X()]))}},[e,r]),(0,a.useEffect)(()=>{if(g){let e=V.find(e=>e.id===g);e?.taxNumber&&S(e.taxNumber)}},[g,V]);let X=()=>({id:`item-${Date.now()}`,description:"",quantity:1,unitPrice:0,ddvRate:22,ddvAmount:0,total:0}),Z=(e,t,a)=>{K(H.map(s=>{if(s.id!==e)return s;let l={...s,[t]:a},r=l.quantity*l.unitPrice;return l.ddvAmount=r*(l.ddvRate/100),l.total=r+l.ddvAmount,l}))},Y=H.reduce((e,t)=>e+t.quantity*t.unitPrice,0),W=H.reduce((e,t)=>e+t.ddvAmount,0),Q=Y+W,J=async()=>{if(!c.trim())return void E.toast.error("Lutfen fatura numarasi girin!");if(!j)return void E.toast.error("Lutfen sube secin!");if(0===H.length||H.every(e=>!e.description))return void E.toast.error("Lutfen en az bir kalem ekleyin!");q(!0);try{let e=V.find(e=>e.id===g),t={invoice_number:c.trim(),invoiceNo:c.trim(),type:"purchase",invoice_date:u,date:u,due_date:x||null,dueDate:x||null,branch_id:j,branchId:j,supplier_id:g||null,supplierId:g||null,supplier_name:e?.name||"",supplier:e?.name||"",supplierDdvNo:b.trim(),status:T,paymentStatus:L,items:H.filter(e=>e.description).map(e=>({name:e.description,description:e.description,quantity:e.quantity,unit_price:e.unitPrice,unitPrice:e.unitPrice,tax_rate:e.ddvRate,ddvRate:e.ddvRate,tax_base:e.quantity*e.unitPrice,tax_amount:e.ddvAmount,ddvAmount:e.ddvAmount,line_total:e.total,total:e.total})),subtotal:Y,total_tax:W,vatAmount:W,grand_total:Q,total:Q,total_paid:"paid"===L?Q:0,remaining_amount:"paid"===L?0:Q,notes:B.trim(),currency:"EUR",updatedAt:new Date().toISOString()};i&&r?.id?(await (0,k.updateFirestoreData)("purchases",r.id,t),E.toast.success("Fatura guncellendi")):(t.createdAt=new Date().toISOString(),t.created_at=new Date().toISOString(),await (0,k.addFirestoreData)("purchases",t),E.toast.success("Fatura olusturuldu")),l(!1),n?.()}catch(e){console.error("Save error:",e),E.toast.error("Kaydetme hatasi: "+e.message)}finally{q(!1)}};return(0,t.jsx)(_.Dialog,{open:e,onOpenChange:l,children:(0,t.jsxs)(_.DialogContent,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(_.DialogHeader,{children:(0,t.jsx)(_.DialogTitle,{className:"text-xl font-semibold",children:i?"Alis Faturasi Duzenle":"Yeni Alis Faturasi"})}),(0,t.jsxs)("div",{className:"grid gap-6 py-4",children:[(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("h3",{className:"text-sm font-medium text-muted-foreground border-b pb-2",children:"Fatura Bilgileri"}),(0,t.jsxs)("div",{className:"grid grid-cols-5 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(D.Label,{htmlFor:"branchId",className:"flex items-center gap-1",children:[(0,t.jsx)(h.Store,{className:"h-4 w-4"}),"Hedef Depo"]}),(0,t.jsxs)(C.Select,{value:j,onValueChange:f,children:[(0,t.jsx)(C.SelectTrigger,{children:(0,t.jsx)(C.SelectValue,{placeholder:"Depo secin"})}),(0,t.jsx)(C.SelectContent,{children:R.map(e=>(0,t.jsxs)(C.SelectItem,{value:e.id,children:[e.icon," ",e.name]},e.id))})]}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Tum alislar Merkez Depo'ya yapilir"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{htmlFor:"invoiceNo",children:"Fatura No *"}),(0,t.jsx)(y.Input,{id:"invoiceNo",value:c,onChange:e=>o(e.target.value),placeholder:"Orn: ALI-2024-001"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{htmlFor:"invoiceDate",children:"Fatura Tarihi *"}),(0,t.jsx)(y.Input,{id:"invoiceDate",type:"date",value:u,onChange:e=>m(e.target.value)})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{htmlFor:"dueDate",children:"Vade Tarihi"}),(0,t.jsx)(y.Input,{id:"dueDate",type:"date",value:x,onChange:e=>p(e.target.value)})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{htmlFor:"status",children:"Durum"}),(0,t.jsxs)(C.Select,{value:T,onValueChange:w,children:[(0,t.jsx)(C.SelectTrigger,{children:(0,t.jsx)(C.SelectValue,{placeholder:"Durum secin"})}),(0,t.jsx)(C.SelectContent,{children:F.map(e=>(0,t.jsx)(C.SelectItem,{value:e.value,children:e.label},e.value))})]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("h3",{className:"text-sm font-medium text-muted-foreground border-b pb-2",children:"Tedarikci Bilgileri"}),(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{htmlFor:"supplier",children:"Tedarikci"}),(0,t.jsxs)(C.Select,{value:g,onValueChange:N,children:[(0,t.jsx)(C.SelectTrigger,{children:(0,t.jsx)(C.SelectValue,{placeholder:"Tedarikci secin"})}),(0,t.jsx)(C.SelectContent,{children:V.filter(e=>e.id).map(e=>(0,t.jsx)(C.SelectItem,{value:e.id,children:e.name},e.id))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{htmlFor:"supplierDdvNo",children:"Tedarikci DDV No"}),(0,t.jsx)(y.Input,{id:"supplierDdvNo",value:b,onChange:e=>S(e.target.value),placeholder:"SI12345678"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{htmlFor:"paymentStatus",children:"Odeme Durumu"}),(0,t.jsxs)(C.Select,{value:L,onValueChange:M,children:[(0,t.jsx)(C.SelectTrigger,{children:(0,t.jsx)(C.SelectValue,{placeholder:"Odeme durumu secin"})}),(0,t.jsx)(C.SelectContent,{children:P.map(e=>(0,t.jsx)(C.SelectItem,{value:e.value,children:e.label},e.value))})]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between border-b pb-2",children:[(0,t.jsx)("h3",{className:"text-sm font-medium text-muted-foreground",children:"Fatura Kalemleri"}),(0,t.jsxs)(v.Button,{type:"button",variant:"outline",size:"sm",onClick:()=>{K([...H,X()])},children:[(0,t.jsx)(s.Plus,{className:"h-4 w-4 mr-1"}),"Kalem Ekle"]})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 text-xs font-medium text-muted-foreground px-1",children:[(0,t.jsx)("div",{className:"col-span-4",children:"Aciklama"}),(0,t.jsx)("div",{className:"col-span-1",children:"Miktar"}),(0,t.jsx)("div",{className:"col-span-2",children:"Birim Fiyat"}),(0,t.jsx)("div",{className:"col-span-2",children:"DDV %"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Toplam"}),(0,t.jsx)("div",{className:"col-span-1"})]}),H.map(e=>(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 items-center",children:[(0,t.jsx)("div",{className:"col-span-4",children:(0,t.jsx)(y.Input,{value:e.description,onChange:t=>Z(e.id,"description",t.target.value),placeholder:"Urun/hizmet aciklamasi"})}),(0,t.jsx)("div",{className:"col-span-1",children:(0,t.jsx)(y.Input,{type:"number",value:e.quantity,onChange:t=>Z(e.id,"quantity",parseFloat(t.target.value)||0),min:"0",step:"1"})}),(0,t.jsx)("div",{className:"col-span-2",children:(0,t.jsx)(y.Input,{type:"number",value:e.unitPrice,onChange:t=>Z(e.id,"unitPrice",parseFloat(t.target.value)||0),min:"0",step:"0.01"})}),(0,t.jsx)("div",{className:"col-span-2",children:(0,t.jsxs)(C.Select,{value:String(e.ddvRate),onValueChange:t=>Z(e.id,"ddvRate",parseFloat(t)),children:[(0,t.jsx)(C.SelectTrigger,{children:(0,t.jsx)(C.SelectValue,{})}),(0,t.jsx)(C.SelectContent,{children:A.map(e=>(0,t.jsx)(C.SelectItem,{value:String(e.value),children:e.label},e.value))})]})}),(0,t.jsxs)("div",{className:"col-span-2 text-right font-mono font-semibold",children:[e.total.toFixed(2)," EUR"]}),(0,t.jsx)("div",{className:"col-span-1 flex justify-end",children:(0,t.jsx)(v.Button,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>{var t;return t=e.id,void(H.length>1&&K(H.filter(e=>e.id!==t)))},disabled:1===H.length,children:(0,t.jsx)(d.Trash2,{className:"h-4 w-4"})})})]},e.id))]}),(0,t.jsxs)("div",{className:"border-t pt-4 space-y-2",children:[(0,t.jsxs)("div",{className:"flex justify-end gap-8 text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Ara Toplam:"}),(0,t.jsxs)("span",{className:"font-mono w-24 text-right",children:[Y.toFixed(2)," EUR"]})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-8 text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"DDV Toplam:"}),(0,t.jsxs)("span",{className:"font-mono w-24 text-right",children:[W.toFixed(2)," EUR"]})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-8 text-lg font-semibold",children:[(0,t.jsx)("span",{children:"Genel Toplam:"}),(0,t.jsxs)("span",{className:"font-mono w-24 text-right text-primary",children:[Q.toFixed(2)," EUR"]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{htmlFor:"notes",children:"Notlar"}),(0,t.jsx)(I.Textarea,{id:"notes",value:B,onChange:e=>O(e.target.value),placeholder:"Ek notlar, referanslar...",rows:2})]})]}),(0,t.jsxs)(_.DialogFooter,{children:[(0,t.jsx)(v.Button,{variant:"outline",onClick:()=>l(!1),disabled:U,children:"Iptal"}),(0,t.jsx)(v.Button,{onClick:J,disabled:U,children:U?"Kaydediliyor...":"Kaydet"})]})]})})}var M=e.i(69638),B=e.i(73884),O=e.i(78894),H=e.i(15788),K=e.i(88844),U=e.i(68148);let q={eslog:{name:"eSLOG 2.0 (Slovenya)",country:"SI"},ebinterface:{name:"ebInterface (Avusturya)",country:"AT"},xrechnung:{name:"XRechnung (Almanya)",country:"DE"},zugferd:{name:"ZUGFeRD (Almanya)",country:"DE"},"ubl-tr":{name:"UBL-TR (T√ºrkiye)",country:"TR"},ubl:{name:"UBL 2.1",country:"EU"},"onk-excel":{name:"ONK Business Central Excel XML",country:"AT"}},V={transport:["fracht","freight","transport","nakliye","shipping","delivery","versand","spedition","lieferung","prevoz","dostava","kargo"],customs:["zoll","customs","g√ºmr√ºk","carina","duty","import","export","verzollung"],handling:["handling","bearbeitung","i≈ülem","obdelava","manipulation"],packaging:["verpackung","packaging","ambalaj","embala≈æa","paket"],insurance:["versicherung","insurance","sigorta","zavarovanje"]};function z({open:e,onOpenChange:s,onSuccess:l}){let[r,i]=(0,a.useState)("upload"),[d,c]=(0,a.useState)(null),[o,u]=(0,a.useState)(null),[p,j]=(0,a.useState)(!1),[f,g]=(0,a.useState)(!1),[T,w]=(0,a.useState)(""),[I,A]=(0,a.useState)(""),[F,P]=(0,a.useState)(0),[R,L]=(0,a.useState)(0),[z,X]=(0,a.useState)([]),[Z,Y]=(0,a.useState)([]),[W,Q]=(0,a.useState)([]);(0,a.useEffect)(()=>{if(!e)return;let t=(0,k.subscribeToRTDB)("partners",e=>{if(e){let t=e.filter(e=>e.basic?.type==="supplier"||"supplier"===e.type).map(e=>({id:e.id||e._id,name:e.basic?.name||e.name||e.companyName||"",taxId:e.tax?.taxId||e.financial?.vatNumber||e.taxNumber||""})).filter(e=>e.name);t.sort((e,t)=>e.name.localeCompare(t.name)),X(t)}}),a=(0,k.subscribeToBranches)(e=>{Y(e||[])}),s=(0,k.subscribeToRTDB)("products",e=>{e&&Q(e.map(e=>({id:e.id||e._id,name:e.basic?.name||e.name||e.productName||"",code:e.basic?.stockCode||e.code||e.sku||"",barcode:e.barcode||"",supplierMappings:e.supplierMappings||{}})))});return()=>{t(),a(),s()}},[e]),(0,a.useEffect)(()=>{e||(i("upload"),c(null),u(null),w(""),A(""),P(0),L(0))},[e]);let J=e=>{if(!e)return{isExpense:!1,expenseType:""};let t=e.toLowerCase();for(let[e,a]of Object.entries(V))for(let s of a)if(t.includes(s))return{isExpense:!0,expenseType:e};return{isExpense:!1,expenseType:""}},ee=(0,a.useCallback)(async e=>{let t=new DOMParser().parseFromString(e,"text/xml"),a=t.querySelector("parsererror");if(a)throw Error("Ge√ßersiz XML dosyasƒ±: "+(a.textContent||""));let{format:s,country:l}=(e=>{let t=e.documentElement,a=t.tagName.toLowerCase(),s=t.getAttribute("xmlns")||"",l=Array.from(t.attributes).map(e=>e.value.toLowerCase()).join(" "),r=e.childNodes;for(let e=0;e<r.length;e++){let t=r[e];if(t.nodeType===Node.PROCESSING_INSTRUCTION_NODE&&"mso-application"===t.nodeName&&(t.nodeValue||"").includes("Excel.Sheet"))return{format:"onk-excel",country:"AT"}}if("workbook"===a&&(s.includes("office:spreadsheet")||s.includes("schemas-microsoft-com:office:spreadsheet")))return{format:"onk-excel",country:"AT"};if(s.includes("eslog")||s.includes("urn:eslog")||s.includes("gzs.si")||l.includes("eslog"))return{format:"eslog",country:"SI"};if(s.includes("ebinterface")||l.includes("ebinterface"))return{format:"ebinterface",country:"AT"};if(a.includes("crossindustryinvoice")||s.includes("crossindustryinvoice"))return{format:"zugferd",country:"DE"};let n=e.querySelector("CustomizationID");if(n?.textContent?.includes("TR"))return{format:"ubl-tr",country:"TR"};let i=e.querySelector("ProfileID");return i?.textContent?.toLowerCase().includes("xrechnung")?{format:"xrechnung",country:"DE"}:a.includes("invoice")?{format:"ubl",country:"EU"}:{format:"unknown",country:"UNKNOWN"}})(t);if("onk-excel"===s){let e,a,s,l,r,n,i,d;return e=t.querySelectorAll("Worksheet"),a="",s=new Date().toISOString().split("T")[0],l="",r=[],n={transport:0,customs:0,other:0},e.forEach(e=>{let t=e.getAttribute("ss:Name")||"",i=e.querySelectorAll("Row");if("Allgemein"===t&&i.forEach(e=>{let t=e.querySelectorAll("Cell");if(t.length>=2){let e=t[0]?.querySelector("Data")?.textContent?.trim()||"",r=t[1]?.querySelector("Data")?.textContent?.trim()||"";"Nr."===e?a=r:"Verk. an Name"===e?l=r:"Verk. an Adresse"===e||("Buchungsdatum"===e||"Belegdatum"===e)&&r&&(s=r.split("T")[0])}}),t.startsWith("Bearbeiten")&&!t.includes("1")){let e=[],t=!0,a=0;i.forEach((s,l)=>{let i=s.querySelectorAll("Cell"),d=[];if(i.forEach(e=>{let t=e.querySelector("Data");d.push(t?.textContent?.trim()||"")}),!(l<2)){if(d.some(e=>"Zeilennr."===e||"Nr."===e||"Beschreibung"===e)){e=d,t=!1;return}if(!t&&e.length>0&&d.length>=5){let t=t=>{let a=e.indexOf(t);return a>=0&&a<d.length?d[a]:""},s=t("Nr.")||t("Artikelnr."),l=t("Beschreibung")||t("Name")||"",i=t("Menge")||t("Menge (Basis)")||"1",c=t("VK-Preis Ohne MwSt.")||t("VK-Preis (Preisbasis)")||"0",o=t("Zeilenbetrag Ohne MwSt.")||"0",u=t("Einheit")||"KOM",m=t("MwSt.-Produktbuchungsgruppe")||"10";if(!l||""===l)return;let x=parseFloat(i.replace(",","."))||1,h=parseFloat(c.replace(",","."))||0,p=parseFloat(o.replace(",","."))||x*h,j=parseFloat(m.replace(",","."))||10,f=j/100*p,{isExpense:g,expenseType:N}=J(l);g&&("transport"===N?n.transport+=p:"customs"===N?n.customs+=p:n.other+=p),r.push({id:`item-${a}`,supplierCode:s,description:l,quantity:x,unit:G(u),unitPrice:h,taxRate:j,taxAmount:f,lineTotal:p+f,matchStatus:"unmatched",isExpense:g,expenseType:N}),a++}}})}}),i=r.reduce((e,t)=>e+t.unitPrice*t.quantity,0),d=r.reduce((e,t)=>e+t.taxAmount,0),{format:"onk-excel",country:"AT",invoiceNumber:a||`IMP-${Date.now()}`,invoiceDate:s,currency:"EUR",supplier:{name:"ONK Gro√ühandel",taxId:"",address:""},customer:{name:l,taxId:""},items:r,subtotal:i,totalTax:d,grandTotal:i+d,detectedExpenses:n}}let r=(e,a="")=>{for(let a of e)try{let e=t.querySelector(a);if(e?.textContent?.trim())return e.textContent.trim();let s=a.split(/[\s>]/).pop()?.replace(/[^\w]/g,"")||"";if(s){let e=t.getElementsByTagName(s);if(e.length>0&&e[0].textContent?.trim())return e[0].textContent.trim();for(let e of["cbc:","cac:","ram:","rsm:","eslog:","eb:"]){let a=t.getElementsByTagName(e+s);if(a.length>0&&a[0].textContent?.trim())return a[0].textContent.trim()}}}catch{continue}return a},n=(e,t=0)=>{let a=parseFloat(r(e).replace(",","."));return isNaN(a)?t:a},i=r(["InvoiceNumber","ID","cbc\\:ID","InvoiceId","S_BGM C_C106 D_1004","D_1004","ExchangedDocument ID"])||`IMP-${Date.now()}`,d=r(["InvoiceDate","IssueDate","cbc\\:IssueDate","S_DTM C_C507 D_2380","D_2380","IssueDateTime DateTimeString"])||new Date().toISOString().split("T")[0],c=r(["DueDate","PaymentDueDate","cbc\\:DueDate","PaymentDate"]),o=r(["Currency","DocumentCurrencyCode","cbc\\:DocumentCurrencyCode","InvoiceCurrencyCode","S_CUX C_C504 D_6345","D_6345"])||"EUR",u="",m="",x="";"eslog"===s?t.querySelectorAll("G_SG2").forEach(e=>{if("SE"===e.querySelector("D_3035")?.textContent?.trim()){u=e.querySelector("D_3036")?.textContent?.trim()||"",x=e.querySelector("D_3042")?.textContent?.trim()||"";let t=e.querySelector("D_1154");t&&(m=t.textContent?.trim()||"")}}):(u=r(["AccountingSupplierParty Party PartyName Name","AccountingSupplierParty PartyName Name","SellerTradeParty Name","Biller Name","SellerParty Name"]),m=r(["AccountingSupplierParty Party PartyTaxScheme CompanyID","AccountingSupplierParty PartyTaxScheme CompanyID","SellerTradeParty SpecifiedTaxRegistration ID","Biller VATIdentificationNumber"]));let h=[],p={transport:0,customs:0,other:0},j=0,f=[];for(let e of["G_SG26","InvoiceLine","ListLineItem","IncludedSupplyChainTradeLineItem"]){let a=t.querySelectorAll(e);if(a.length>0){f=Array.from(a);break}let s=t.getElementsByTagName(e);if(s.length>0){f=Array.from(s);break}}f.forEach(e=>{let t=t=>{for(let a of t)try{let t=e.querySelector(a);if(t?.textContent?.trim())return t.textContent.trim();let s=a.split(/[\s>]/).pop()?.replace(/[^\w]/g,"")||"";if(s){let t=e.getElementsByTagName(s);if(t.length>0&&t[0].textContent?.trim())return t[0].textContent.trim()}}catch{continue}return""},a=e=>{let a=parseFloat(t(e).replace(",","."));return isNaN(a)?0:a},s=t(["D_7008","Name","Description","SpecifiedTradeProduct Name"])||`Kalem ${j+1}`,l=t(["D_7140","SellersItemIdentification ID","ArticleNumber","SellerAssignedID","StandardItemIdentification ID"]),r=a(["D_6060","InvoicedQuantity","Quantity","BilledQuantity"])||1,n=t(["D_6411","unitCode","Unit"])||"KOM";n=G(n);let i=a(["D_5118","PriceAmount","UnitPrice","ChargeAmount"]),d=a(["D_5278","Percent","TaxRate","RateApplicablePercent"])||22,c=a(["D_5004","LineExtensionAmount","Amount","LineTotalAmount"])||r*i,o=d/100*c,{isExpense:u,expenseType:m}=J(s);u&&("transport"===m?p.transport+=c:"customs"===m?p.customs+=c:p.other+=c),h.push({id:`item-${j}`,supplierCode:l,description:s,quantity:r,unit:n,unitPrice:i,taxRate:d,taxAmount:o,lineTotal:c+o,matchStatus:"unmatched",isExpense:u,expenseType:m}),j++}),0===h.length&&h.push({id:"item-0",description:"Manuel giri≈ü gerekli",quantity:1,unit:"KOM",unitPrice:0,taxRate:22,taxAmount:0,lineTotal:0,matchStatus:"unmatched"});let g=n(["TaxExclusiveAmount","TotalGrossAmount","LineExtensionAmount",'D_5004[D_5025="79"]',"LineTotalAmount"])||h.reduce((e,t)=>e+t.unitPrice*t.quantity,0),N=n(["TaxAmount","TaxTotalAmount",'D_5004[D_5025="176"]'])||h.reduce((e,t)=>e+t.taxAmount,0),b=n(["PayableAmount","TaxInclusiveAmount","GrandTotalAmount",'D_5004[D_5025="9"]',"Total"])||g+N;return{format:s,country:l,invoiceNumber:i,invoiceDate:$(d),dueDate:c?$(c):void 0,currency:o,supplier:{name:u,taxId:m,address:x},items:h,subtotal:g,totalTax:N,grandTotal:b,detectedExpenses:p}},[]),et=async e=>{let t=e.target.files?.[0];if(t){if(!t.name.toLowerCase().endsWith(".xml"))return void E.toast.error("L√ºtfen bir XML dosyasƒ± se√ßin");c(t),j(!0);try{let e=await t.text(),a=await ee(e);if(a.supplier.taxId){let e=a.supplier.taxId.replace(/[^a-zA-Z0-9]/g,"").toUpperCase(),t=z.find(t=>{let a=(t.taxId||"").replace(/[^a-zA-Z0-9]/g,"").toUpperCase();return a===e||a.replace(/^[A-Z]{2}/,"")===e.replace(/^[A-Z]{2}/,"")});t&&A(t.id)}let s=a.items.map(e=>ea(e,W,I));a.items=s,a.detectedExpenses.transport>0&&P(a.detectedExpenses.transport),a.detectedExpenses.customs>0&&L(a.detectedExpenses.customs),u(a),i("review"),E.toast.success(`XML ba≈üarƒ±yla okundu: ${a.items.length} kalem`)}catch(e){console.error("XML parse error:",e),E.toast.error("XML dosyasƒ± okunamadƒ±: "+e.message)}finally{j(!1)}}},ea=(e,t,a)=>{if(e.isExpense)return e;if(e.supplierCode&&a){let s=t.find(t=>t.supplierMappings?.[a]?.code?.toLowerCase()===e.supplierCode?.toLowerCase());if(s)return{...e,matchedProductId:s.id,matchedProductName:s.name,matchStatus:"matched"}}if(e.supplierCode){let a=t.find(t=>t.code?.toLowerCase()===e.supplierCode?.toLowerCase());if(a)return{...e,matchedProductId:a.id,matchedProductName:a.name,matchStatus:"matched"}}let s=e.description.toLowerCase(),l=t.find(e=>e.name.toLowerCase().includes(s)||s.includes(e.name.toLowerCase()));return l?{...e,matchedProductId:l.id,matchedProductName:l.name,matchStatus:"suggested"}:e};(0,a.useEffect)(()=>{if(o&&I){let e=o.items.map(e=>ea(e,W,I));u({...o,items:e})}},[I]);let es=(o?.grandTotal||0)+F+R,el=o?.items.filter(e=>!e.isExpense)||[],er=el.filter(e=>"matched"===e.matchStatus).length,en=el.filter(e=>"suggested"===e.matchStatus).length,ei=el.filter(e=>"unmatched"===e.matchStatus).length,ed=el.length>0?Math.round(er/el.length*100):0,ec=async()=>{if(!o||!T)return void E.toast.error("L√ºtfen ≈üube se√ßin");g(!0);try{let e=z.find(e=>e.id===I),t={invoice_number:o.invoiceNumber,invoiceNo:o.invoiceNumber,type:"purchase",invoice_date:o.invoiceDate,date:o.invoiceDate,due_date:o.dueDate||null,dueDate:o.dueDate||null,branch_id:T,branchId:T,supplier_id:I||null,supplierId:I||null,supplier_name:e?.name||o.supplier.name,supplier:e?.name||o.supplier.name,supplierVAT:o.supplier.taxId||null,currency:o.currency,items:o.items.filter(e=>!e.isExpense).map(e=>({product_id:e.matchedProductId||null,productId:e.matchedProductId||null,name:e.description,description:e.description,supplier_code:e.supplierCode||null,quantity:e.quantity,unit:e.unit,unit_price:e.unitPrice,unitPrice:e.unitPrice,tax_rate:e.taxRate,ddvRate:e.taxRate,tax_amount:e.taxAmount,ddvAmount:e.taxAmount,line_total:e.lineTotal,total:e.lineTotal})),subtotal:o.subtotal,total_tax:o.totalTax,vatAmount:o.totalTax,expenses:{transport:{amount:F,description:"Nakliye masrafƒ±"},customs:{amount:R,description:"G√ºmr√ºk masrafƒ±"},total:F+R},transport_cost:F,customs_cost:R,total_expense:F+R,grand_total:es,total:es,status:"pending",paymentStatus:"unpaid",importSource:`XML - ${q[o.format]?.name||o.format}`,importCountry:o.country,matchingStats:{totalItems:el.length,matchedItems:er,matchPercentage:ed},notes:`XML import: ${d?.name}`,createdAt:new Date().toISOString(),created_at:new Date().toISOString()};await (0,k.addFirestoreData)("purchases",t),E.toast.success("Fatura ba≈üarƒ±yla eklendi"),s(!1),l?.()}catch(e){console.error("Save error:",e),E.toast.error("Kaydetme hatasƒ±: "+e.message)}finally{g(!1)}};return(0,t.jsx)(_.Dialog,{open:e,onOpenChange:s,children:(0,t.jsxs)(_.DialogContent,{className:"max-w-5xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(_.DialogHeader,{children:(0,t.jsxs)(_.DialogTitle,{className:"text-xl font-semibold flex items-center gap-2",children:[(0,t.jsx)(m.FileText,{className:"h-5 w-5"}),"XML E-Fatura ƒ∞√ße Aktar"]})}),"upload"===r&&(0,t.jsxs)("div",{className:"space-y-6 py-4",children:[(0,t.jsxs)(b.Card,{children:[(0,t.jsx)(b.CardHeader,{children:(0,t.jsx)(b.CardTitle,{className:"text-sm",children:"Desteklenen Formatlar"})}),(0,t.jsx)(b.CardContent,{children:(0,t.jsx)("div",{className:"grid grid-cols-3 gap-2 text-sm",children:Object.entries(q).map(([e,a])=>(0,t.jsxs)("div",{className:"flex items-center gap-2 text-muted-foreground",children:[(0,t.jsx)(M.CheckCircle,{className:"h-3 w-3 text-green-500"}),a.name]},e))})})]}),(0,t.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[(0,t.jsx)(N,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),(0,t.jsx)("p",{className:"text-lg font-medium mb-2",children:"XML Dosyasƒ± Se√ßin"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:"e-Fatura XML dosyasƒ±nƒ± y√ºkleyin"}),(0,t.jsx)(y.Input,{type:"file",accept:".xml",onChange:et,className:"max-w-xs mx-auto",disabled:p}),p&&(0,t.jsxs)("div",{className:"mt-4 flex items-center justify-center gap-2",children:[(0,t.jsx)(x.RefreshCw,{className:"h-4 w-4 animate-spin"}),(0,t.jsx)("span",{children:"XML okunuyor..."})]})]})]}),"review"===r&&o&&(0,t.jsxs)("div",{className:"space-y-4 py-4",children:[(0,t.jsxs)(b.Card,{children:[(0,t.jsx)(b.CardHeader,{className:"pb-2",children:(0,t.jsx)(b.CardTitle,{className:"text-sm",children:"Fatura Bilgileri"})}),(0,t.jsx)(b.CardContent,{children:(0,t.jsxs)("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Format:"}),(0,t.jsx)("p",{className:"font-medium",children:q[o.format]?.name||o.format})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Fatura No:"}),(0,t.jsx)("p",{className:"font-medium",children:o.invoiceNumber})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Tarih:"}),(0,t.jsx)("p",{className:"font-medium",children:o.invoiceDate})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Tedarik√ßi:"}),(0,t.jsx)("p",{className:"font-medium",children:o.supplier.name||"-"}),o.supplier.taxId&&(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:o.supplier.taxId})]})]})})]}),(0,t.jsx)(b.Card,{children:(0,t.jsx)(b.CardContent,{className:"pt-4",children:(0,t.jsxs)("div",{className:"flex items-center gap-6",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("span",{className:"text-sm",children:"√úr√ºn E≈üle≈ütirme"}),(0,t.jsxs)("span",{className:"text-sm font-medium",children:[ed,"%"]})]}),(0,t.jsx)(U.Progress,{value:ed,className:"h-2"})]}),(0,t.jsxs)("div",{className:"flex gap-4 text-sm",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(M.CheckCircle,{className:"h-4 w-4 text-green-500"}),(0,t.jsxs)("span",{children:[er," E≈üle≈üti"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(O.AlertTriangle,{className:"h-4 w-4 text-yellow-500"}),(0,t.jsxs)("span",{children:[en," √ñneri"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(B.XCircle,{className:"h-4 w-4 text-red-500"}),(0,t.jsxs)("span",{children:[ei," E≈üle≈ümedi"]})]})]})]})})}),(0,t.jsxs)(b.Card,{children:[(0,t.jsx)(b.CardHeader,{className:"pb-2",children:(0,t.jsxs)(b.CardTitle,{className:"text-sm",children:["Fatura Kalemleri (",o.items.length,")"]})}),(0,t.jsx)(b.CardContent,{children:(0,t.jsx)("div",{className:"max-h-[300px] overflow-y-auto",children:(0,t.jsxs)(S.Table,{children:[(0,t.jsx)(S.TableHeader,{children:(0,t.jsxs)(S.TableRow,{children:[(0,t.jsx)(S.TableHead,{className:"w-[30px]"}),(0,t.jsx)(S.TableHead,{children:"Tedarik√ßi Kodu"}),(0,t.jsx)(S.TableHead,{children:"A√ßƒ±klama"}),(0,t.jsx)(S.TableHead,{className:"text-right",children:"Miktar"}),(0,t.jsx)(S.TableHead,{children:"Birim"}),(0,t.jsx)(S.TableHead,{className:"text-right",children:"Fiyat"}),(0,t.jsx)(S.TableHead,{className:"text-right",children:"KDV %"}),(0,t.jsx)(S.TableHead,{className:"text-right",children:"Toplam"}),(0,t.jsx)(S.TableHead,{children:"E≈üle≈üen √úr√ºn"})]})}),(0,t.jsx)(S.TableBody,{children:o.items.map(e=>(0,t.jsxs)(S.TableRow,{className:e.isExpense?"bg-orange-50":"matched"===e.matchStatus?"bg-green-50":"suggested"===e.matchStatus?"bg-yellow-50":"bg-red-50",children:[(0,t.jsxs)(S.TableCell,{children:[e.isExpense&&(0,t.jsx)(H.Truck,{className:"h-4 w-4 text-orange-500"}),!e.isExpense&&"matched"===e.matchStatus&&(0,t.jsx)(M.CheckCircle,{className:"h-4 w-4 text-green-500"}),!e.isExpense&&"suggested"===e.matchStatus&&(0,t.jsx)(O.AlertTriangle,{className:"h-4 w-4 text-yellow-500"}),!e.isExpense&&"unmatched"===e.matchStatus&&(0,t.jsx)(B.XCircle,{className:"h-4 w-4 text-red-500"})]}),(0,t.jsx)(S.TableCell,{className:"font-mono text-xs",children:e.supplierCode||"-"}),(0,t.jsx)(S.TableCell,{className:"max-w-[200px] truncate",children:e.description}),(0,t.jsx)(S.TableCell,{className:"text-right",children:e.quantity}),(0,t.jsx)(S.TableCell,{children:e.unit}),(0,t.jsx)(S.TableCell,{className:"text-right font-mono",children:e.unitPrice.toFixed(2)}),(0,t.jsxs)(S.TableCell,{className:"text-right",children:[e.taxRate,"%"]}),(0,t.jsx)(S.TableCell,{className:"text-right font-mono font-medium",children:e.lineTotal.toFixed(2)}),(0,t.jsx)(S.TableCell,{children:e.isExpense?(0,t.jsx)("span",{className:"text-xs text-orange-600 font-medium",children:"transport"===e.expenseType?"üöö Nakliye":"customs"===e.expenseType?"üõÉ G√ºmr√ºk":"üì¶ Masraf"}):(0,t.jsxs)(C.Select,{value:e.matchedProductId||"none",onValueChange:t=>((e,t)=>{if(!o)return;let a="none"===t?"":t,s=W.find(e=>e.id===a),l=o.items.map(t=>t.id!==e?t:{...t,matchedProductId:a||void 0,matchedProductName:s?.name||"",matchStatus:a?"matched":"unmatched"});u({...o,items:l})})(e.id,"none"===t?"":t),children:[(0,t.jsx)(C.SelectTrigger,{className:"h-8 text-xs",children:(0,t.jsx)(C.SelectValue,{placeholder:"√úr√ºn se√ß..."})}),(0,t.jsxs)(C.SelectContent,{children:[(0,t.jsx)(C.SelectItem,{value:"none",children:"-- Se√ßim yok --"}),W.filter(e=>e.id).map(e=>(0,t.jsx)(C.SelectItem,{value:e.id,children:e.name},e.id))]})]})})]},e.id))})]})})})]}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsxs)("div",{className:"w-64 space-y-1 text-sm",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Ara Toplam:"}),(0,t.jsxs)("span",{className:"font-mono",children:[o.subtotal.toFixed(2)," ",o.currency]})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"KDV:"}),(0,t.jsxs)("span",{className:"font-mono",children:[o.totalTax.toFixed(2)," ",o.currency]})]}),(0,t.jsxs)("div",{className:"flex justify-between font-medium border-t pt-1",children:[(0,t.jsx)("span",{children:"Genel Toplam:"}),(0,t.jsxs)("span",{className:"font-mono",children:[o.grandTotal.toFixed(2)," ",o.currency]})]})]})}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)(v.Button,{variant:"outline",onClick:()=>i("upload"),children:"Geri"}),(0,t.jsx)(v.Button,{onClick:()=>i("configure"),children:"Devam"})]})]}),"configure"===r&&o&&(0,t.jsxs)("div",{className:"space-y-6 py-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-6",children:[(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{children:"≈ûube *"}),(0,t.jsxs)(C.Select,{value:T,onValueChange:w,children:[(0,t.jsxs)(C.SelectTrigger,{children:[(0,t.jsx)(h.Store,{className:"h-4 w-4 mr-2"}),(0,t.jsx)(C.SelectValue,{placeholder:"≈ûube se√ßin"})]}),(0,t.jsx)(C.SelectContent,{children:Z.filter(e=>e.id&&!1!==e.isActive).map(e=>(0,t.jsx)(C.SelectItem,{value:e.id,children:e.name},e.id))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{children:"Tedarik√ßi"}),(0,t.jsxs)(C.Select,{value:I||"none",onValueChange:e=>A("none"===e?"":e),children:[(0,t.jsxs)(C.SelectTrigger,{children:[(0,t.jsx)(n.Building2,{className:"h-4 w-4 mr-2"}),(0,t.jsx)(C.SelectValue,{placeholder:"Tedarik√ßi se√ßin"})]}),(0,t.jsxs)(C.SelectContent,{children:[(0,t.jsx)(C.SelectItem,{value:"none",children:"-- Se√ßim yok --"}),z.filter(e=>e.id).map(e=>(0,t.jsxs)(C.SelectItem,{value:e.id,children:[e.name,e.taxId&&(0,t.jsxs)("span",{className:"text-xs text-muted-foreground ml-1",children:["(",e.taxId,")"]})]},e.id))]})]}),o.supplier.name&&!I&&(0,t.jsxs)("p",{className:"text-xs text-muted-foreground",children:["XML'den: ",o.supplier.name]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(D.Label,{className:"flex items-center gap-2",children:[(0,t.jsx)(H.Truck,{className:"h-4 w-4"}),"Nakliye Masrafƒ± (EUR)"]}),(0,t.jsx)(y.Input,{type:"number",value:F,onChange:e=>P(parseFloat(e.target.value)||0),min:"0",step:"0.01"}),o.detectedExpenses.transport>0&&(0,t.jsxs)("p",{className:"text-xs text-orange-600",children:["XML'den tespit edildi: ",o.detectedExpenses.transport.toFixed(2)," EUR"]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(D.Label,{className:"flex items-center gap-2",children:[(0,t.jsx)(K.Package,{className:"h-4 w-4"}),"G√ºmr√ºk Masrafƒ± (EUR)"]}),(0,t.jsx)(y.Input,{type:"number",value:R,onChange:e=>L(parseFloat(e.target.value)||0),min:"0",step:"0.01"}),o.detectedExpenses.customs>0&&(0,t.jsxs)("p",{className:"text-xs text-orange-600",children:["XML'den tespit edildi: ",o.detectedExpenses.customs.toFixed(2)," EUR"]})]})]}),(0,t.jsxs)(b.Card,{children:[(0,t.jsx)(b.CardHeader,{children:(0,t.jsx)(b.CardTitle,{className:"text-sm",children:"Fatura √ñzeti"})}),(0,t.jsxs)(b.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Fatura No:"}),(0,t.jsx)("span",{className:"font-medium",children:o.invoiceNumber})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Tarih:"}),(0,t.jsx)("span",{children:o.invoiceDate})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Kalem Sayƒ±sƒ±:"}),(0,t.jsx)("span",{children:el.length})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"E≈üle≈üen:"}),(0,t.jsxs)("span",{className:"text-green-600",children:[er," / ",el.length]})]})]}),(0,t.jsxs)("div",{className:"border-t pt-4 space-y-2",children:[(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Fatura Toplamƒ±:"}),(0,t.jsxs)("span",{className:"font-mono",children:[o.grandTotal.toFixed(2)," EUR"]})]}),F>0&&(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Nakliye:"}),(0,t.jsxs)("span",{className:"font-mono",children:["+",F.toFixed(2)," EUR"]})]}),R>0&&(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"G√ºmr√ºk:"}),(0,t.jsxs)("span",{className:"font-mono",children:["+",R.toFixed(2)," EUR"]})]}),(0,t.jsxs)("div",{className:"flex justify-between text-lg font-semibold border-t pt-2",children:[(0,t.jsx)("span",{children:"Genel Toplam:"}),(0,t.jsxs)("span",{className:"text-primary font-mono",children:[es.toFixed(2)," EUR"]})]})]})]})]})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)(v.Button,{variant:"outline",onClick:()=>i("review"),children:"Geri"}),(0,t.jsx)(v.Button,{onClick:ec,disabled:f||!T,children:f?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.RefreshCw,{className:"h-4 w-4 mr-2 animate-spin"}),"Kaydediliyor..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(M.CheckCircle,{className:"h-4 w-4 mr-2"}),"Fatura Olu≈ütur"]})})]})]})]})})}function G(e){return({C62:"KOM",EA:"KOM",PCE:"KOM",PCS:"KOM",ST:"KOM",KGM:"KG",GRM:"GR",LTR:"LT",MTR:"M",MTK:"M2",H87:"KOM"})[e.toUpperCase()]||e}function $(e){if(!e)return new Date().toISOString().split("T")[0];let t=[/^(\d{4})-(\d{2})-(\d{2})/,/^(\d{4})(\d{2})(\d{2})/,/^(\d{2})\.(\d{2})\.(\d{4})/,/^(\d{2})\/(\d{2})\/(\d{4})/];for(let a=0;a<t.length;a++){let s=e.match(t[a]);if(s)if(0===a)return e.substring(0,10);else if(1===a)return`${s[1]}-${s[2]}-${s[3]}`;else return`${s[3]}-${s[2]}-${s[1]}`}return e}var X=e.i(70016);let Z={supplierCode:["tedarikci","tedarik√ßi","supplier","partner","kod","code","sifra","≈üifra"],ourCode:["bizim","sifra","≈üifra","kod","code","sku","stok"],productName:["urun","√ºr√ºn","product","ad","name","isim","aciklama","a√ßƒ±klama","description"],quantity:["miktar","quantity","qty","adet","amount","kolicina","menge"],unit:["birim","unit","olcu","√∂l√ß√º","einheit"],unitPrice:["fiyat","price","tutar","cena","preis","birim fiyat"],taxRate:["kdv","ddv","vat","tax","vergi","oran"]};function Y({open:e,onOpenChange:s,onSuccess:l}){let[r,i]=(0,a.useState)("config"),[d,c]=(0,a.useState)(null),[u,m]=(0,a.useState)([]),[p,j]=(0,a.useState)({supplierCode:null,ourCode:null,productName:null,quantity:null,unit:null,unitPrice:null,taxRate:null}),[f,T]=(0,a.useState)([]),[w,I]=(0,a.useState)(!1),[A,F]=(0,a.useState)(!1),[P,R]=(0,a.useState)(""),[L,q]=(0,a.useState)(""),[V,z]=(0,a.useState)(""),[G,$]=(0,a.useState)(new Date().toISOString().split("T")[0]),[Y,W]=(0,a.useState)(""),[Q,J]=(0,a.useState)(0),[ee,et]=(0,a.useState)(0),[ea,es]=(0,a.useState)(0),[el,er]=(0,a.useState)(22),[en,ei]=(0,a.useState)([]),[ed,ec]=(0,a.useState)([]),[eo,eu]=(0,a.useState)([]);(0,a.useEffect)(()=>{let e=(0,k.subscribeToRTDB)("partners",e=>{if(e){let t=e.filter(e=>e.basic?.type==="supplier"||"supplier"===e.type).map(e=>({id:e.id||e._id,name:e.basic?.name||e.name||e.companyName||"",taxId:e.tax?.taxId||e.financial?.vatNumber||e.taxNumber||""})).filter(e=>e.name);t.sort((e,t)=>e.name.localeCompare(t.name)),ei(t)}}),t=(0,k.subscribeToBranches)(e=>{ec(e||[])}),a=(0,k.subscribeToRTDB)("products",e=>{e&&eu(e.map(e=>({id:e.id||e._id,name:e.name||e.productName||"",code:e.code||e.sku||"",barcode:e.barcode||"",supplierMappings:e.supplierMappings||{}})))});return()=>{e(),t(),a()}},[]),(0,a.useEffect)(()=>{e||(i("config"),c(null),m([]),T([]),j({supplierCode:null,ourCode:null,productName:null,quantity:null,unit:null,unitPrice:null,taxRate:null}),R(""),q(""),z(""),$(new Date().toISOString().split("T")[0]),W(""),J(0),et(0),es(0))},[e]),(0,a.useEffect)(()=>{if(G){let e=new Date(G);e.setDate(e.getDate()+30),W(e.toISOString().split("T")[0])}},[G]);let em=(0,a.useCallback)(e=>{let t={supplierCode:null,ourCode:null,productName:null,quantity:null,unit:null,unitPrice:null,taxRate:null};return e.forEach((e,a)=>{let s=e.toLowerCase().trim();for(let[e,l]of Object.entries(Z))l.some(e=>s.includes(e))&&null===t[e]&&(t[e]=a)}),t},[]),ex=(0,a.useCallback)((e,t,a)=>{if(e.ourCode){let a=t.find(t=>t.code?.toLowerCase()===e.ourCode?.toLowerCase());if(a)return{...e,matchedProductId:a.id,matchedProductName:a.name,matchStatus:"matched"}}if(e.supplierCode&&a){let s=t.find(t=>t.supplierMappings?.[a]?.code?.toLowerCase()===e.supplierCode?.toLowerCase());if(s)return{...e,matchedProductId:s.id,matchedProductName:s.name,matchStatus:"matched"}}if(e.productName){let a=e.productName.toLowerCase(),s=t.find(e=>e.name.toLowerCase().includes(a)||a.includes(e.name.toLowerCase()));if(s)return{...e,matchedProductId:s.id,matchedProductName:s.name,matchStatus:"suggested"}}return{...e,matchStatus:"unmatched"}},[]),eh=(0,a.useCallback)(async e=>{let t=X.read(e,{type:"array"}),a=t.Sheets[t.SheetNames[0]],s=X.utils.sheet_to_json(a,{header:1});if(s.length<2)throw Error("Excel dosyasi bos veya sadece baslik satiri var");let l=s[0].map(e=>String(e||""));T(l);let r=em(l);j(r);let n=[];for(let e=1;e<s.length;e++){let t=s[e];if(!t||t.every(e=>null==e||""===e))continue;let a=e=>null==e?null:t[e],l=a(r.supplierCode)?.toString()||"",i=a(r.ourCode)?.toString()||"",d=a(r.productName)?.toString()||`Satir ${e+1}`,c=parseFloat(a(r.quantity))||1,o=a(r.unit)?.toString()||"KG",u=parseFloat(a(r.unitPrice))||0,m=parseFloat(a(r.taxRate))||el,x=c*u,h={id:`item-${e}`,rowNumber:e+1,supplierCode:l,ourCode:i,productName:d,quantity:c,unit:o,unitPrice:u,taxRate:m,lineTotal:x,matchStatus:"unmatched"},p=ex(h,eo,L);n.push(p)}return n},[em,ex,eo,L,el]),ep=async e=>{let t=e.target.files?.[0];if(t){if(![".xlsx",".xls",".csv"].includes(t.name.toLowerCase().substring(t.name.lastIndexOf("."))))return void E.toast.error("Lutfen bir Excel dosyasi secin (.xlsx, .xls, .csv)");c(t),I(!0);try{let e=await t.arrayBuffer(),a=await eh(e);m(a),i("review"),E.toast.success(`Excel basariyla okundu: ${a.length} kalem`)}catch(e){console.error("Excel parse error:",e),E.toast.error("Excel dosyasi okunamadi: "+e.message)}finally{I(!1)}}},ej=(0,a.useCallback)(()=>{m(u.map(e=>ex(e,eo,L)))},[u,eo,L,ex]),ef=u.reduce((e,t)=>e+t.lineTotal,0),eg=u.reduce((e,t)=>e+t.lineTotal*t.taxRate/100,0),eN=Q+ee+ea,eb=ef+eg+eN,ev=u.filter(e=>"matched"===e.matchStatus).length,ey=u.filter(e=>"suggested"===e.matchStatus).length,eC=u.filter(e=>"unmatched"===e.matchStatus).length,eS=u.length>0?Math.round(ev/u.length*100):0,eT=async()=>{if(!P)return void E.toast.error("Lutfen sube secin");if(!L)return void E.toast.error("Lutfen tedarikci secin");if(!V.trim())return void E.toast.error("Lutfen fatura numarasi girin");if(0===u.length)return void E.toast.error("Fatura kalemleri bos");F(!0);try{let e=en.find(e=>e.id===L),t={invoice_number:V.trim(),invoiceNo:V.trim(),type:"purchase",invoice_date:G,date:G,due_date:Y||null,dueDate:Y||null,branch_id:P,branchId:P,supplier_id:L,supplierId:L,supplier_name:e?.name||"",supplier:e?.name||"",currency:"EUR",items:u.map(e=>({product_id:e.matchedProductId||null,productId:e.matchedProductId||null,name:e.productName,description:e.productName,supplier_code:e.supplierCode||null,our_code:e.ourCode||null,quantity:e.quantity,unit:e.unit,unit_price:e.unitPrice,unitPrice:e.unitPrice,tax_rate:e.taxRate,ddvRate:e.taxRate,tax_amount:e.lineTotal*e.taxRate/100,ddvAmount:e.lineTotal*e.taxRate/100,line_total:e.lineTotal+e.lineTotal*e.taxRate/100,total:e.lineTotal+e.lineTotal*e.taxRate/100})),subtotal:ef,total_tax:eg,vatAmount:eg,transport_cost:Q,customs_cost:ee,other_expenses:ea,total_expense:eN,grand_total:eb,total:eb,status:"pending",paymentStatus:"unpaid",importSource:"Excel",matchingStats:{totalItems:u.length,matchedItems:ev,matchPercentage:eS},notes:`Excel import: ${d?.name}`,createdAt:new Date().toISOString(),created_at:new Date().toISOString()};await (0,k.addFirestoreData)("purchases",t),E.toast.success("Fatura basariyla eklendi"),s(!1),l?.()}catch(e){console.error("Save error:",e),E.toast.error("Kaydetme hatasi: "+e.message)}finally{F(!1)}};return(0,t.jsx)(_.Dialog,{open:e,onOpenChange:s,children:(0,t.jsxs)(_.DialogContent,{className:"max-w-5xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(_.DialogHeader,{children:(0,t.jsxs)(_.DialogTitle,{className:"text-xl font-semibold flex items-center gap-2",children:[(0,t.jsx)(g.FileSpreadsheet,{className:"h-5 w-5"}),"Excel Fatura Iceri Aktar"]})}),"config"===r&&(0,t.jsxs)("div",{className:"space-y-6 py-4",children:[(0,t.jsxs)(b.Card,{children:[(0,t.jsx)(b.CardHeader,{children:(0,t.jsx)(b.CardTitle,{className:"text-sm",children:"Oncelikle Tedarikci ve Sube Secin"})}),(0,t.jsxs)(b.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{children:"Tedarikci *"}),(0,t.jsxs)(C.Select,{value:L,onValueChange:q,children:[(0,t.jsxs)(C.SelectTrigger,{children:[(0,t.jsx)(n.Building2,{className:"h-4 w-4 mr-2"}),(0,t.jsx)(C.SelectValue,{placeholder:"Tedarikci secin"})]}),(0,t.jsx)(C.SelectContent,{children:en.filter(e=>e.id).map(e=>(0,t.jsx)(C.SelectItem,{value:e.id,children:e.name},e.id))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{children:"Sube *"}),(0,t.jsxs)(C.Select,{value:P,onValueChange:R,children:[(0,t.jsxs)(C.SelectTrigger,{children:[(0,t.jsx)(h.Store,{className:"h-4 w-4 mr-2"}),(0,t.jsx)(C.SelectValue,{placeholder:"Sube secin"})]}),(0,t.jsx)(C.SelectContent,{children:ed.filter(e=>e.id&&!1!==e.isActive).map(e=>(0,t.jsx)(C.SelectItem,{value:e.id,children:e.name},e.id))})]})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{children:"Fatura No *"}),(0,t.jsx)(y.Input,{value:V,onChange:e=>z(e.target.value),placeholder:"ALI-2024-001"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{children:"Fatura Tarihi"}),(0,t.jsx)(y.Input,{type:"date",value:G,onChange:e=>$(e.target.value)})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{children:"Vade Tarihi"}),(0,t.jsx)(y.Input,{type:"date",value:Y,onChange:e=>W(e.target.value)})]})]})]})]}),(0,t.jsxs)(b.Card,{children:[(0,t.jsx)(b.CardHeader,{children:(0,t.jsx)(b.CardTitle,{className:"text-sm",children:"Beklenen Excel Formati"})}),(0,t.jsx)(b.CardContent,{children:(0,t.jsxs)("div",{className:"text-sm text-muted-foreground space-y-2",children:[(0,t.jsx)("p",{children:"Excel dosyanizda asagidaki sutunlar otomatik algilanir:"}),(0,t.jsxs)("ul",{className:"list-disc list-inside space-y-1",children:[(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:"Tedarikci Kodu:"})," tedarikci, supplier, partner, kod"]}),(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:"Bizim Sifra:"})," bizim, sifra, kod, sku"]}),(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:"Urun Adi:"})," urun, product, ad, name, aciklama"]}),(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:"Miktar:"})," miktar, quantity, qty, adet"]}),(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:"Birim:"})," birim, unit"]}),(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:"Birim Fiyat:"})," fiyat, price, tutar"]}),(0,t.jsxs)("li",{children:[(0,t.jsx)("strong",{children:"KDV %:"})," kdv, ddv, vat, tax"]})]})]})})]}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)(v.Button,{onClick:()=>i("upload"),disabled:!L||!P||!V.trim(),children:"Devam - Dosya Sec"})})]}),"upload"===r&&(0,t.jsxs)("div",{className:"space-y-6 py-4",children:[(0,t.jsx)(b.Card,{className:"bg-blue-50 border-blue-200",children:(0,t.jsx)(b.CardContent,{className:"pt-4",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(g.FileSpreadsheet,{className:"h-8 w-8 text-blue-600"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-medium text-blue-900",children:"Excel Sablonu"}),(0,t.jsx)("p",{className:"text-sm text-blue-700",children:"Dogru formatta veri yuklemek icin sablonu indirin"})]})]}),(0,t.jsxs)(v.Button,{variant:"outline",onClick:()=>{try{let e=X.utils.book_new(),t=X.utils.aoa_to_sheet([["Tedarikci Kodu","Bizim Sifra","Urun Adi","Miktar","Birim","Birim Fiyat","KDV %"],["P001","URN-001","Dana Kiyma",10,"KG",12.5,9.5],["P002","URN-002","Sut 1L",20,"AD",1.5,9.5],["P003","URN-003","Ekmek",50,"AD",.8,9.5]]);t["!cols"]=[{wch:18},{wch:15},{wch:30},{wch:10},{wch:8},{wch:12},{wch:8}],X.utils.book_append_sheet(e,t,"Alis Faturasi");let a=new Date().toISOString().split("T")[0],s=`Alis_Faturasi_Sablonu_${a}.xlsx`;X.writeFile(e,s),E.toast.success("Excel sablonu indirildi: "+s)}catch(e){console.error("Template download error:",e),E.toast.error("Sablon indirme hatasi: "+e.message)}},className:"border-blue-300 text-blue-700 hover:bg-blue-100",children:[(0,t.jsx)(o.Download,{className:"h-4 w-4 mr-2"}),"Sablon Indir"]})]})})}),(0,t.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[(0,t.jsx)(N,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),(0,t.jsx)("p",{className:"text-lg font-medium mb-2",children:"Excel Dosyasi Secin"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:".xlsx, .xls veya .csv dosyasi yukleyin"}),(0,t.jsx)(y.Input,{type:"file",accept:".xlsx,.xls,.csv",onChange:ep,className:"max-w-xs mx-auto",disabled:w}),w&&(0,t.jsxs)("div",{className:"mt-4 flex items-center justify-center gap-2",children:[(0,t.jsx)(x.RefreshCw,{className:"h-4 w-4 animate-spin"}),(0,t.jsx)("span",{children:"Excel okunuyor..."})]})]}),(0,t.jsx)("div",{className:"flex justify-between",children:(0,t.jsx)(v.Button,{variant:"outline",onClick:()=>i("config"),children:"Geri"})})]}),"review"===r&&(0,t.jsxs)("div",{className:"space-y-4 py-4",children:[(0,t.jsx)(b.Card,{children:(0,t.jsx)(b.CardContent,{className:"pt-4",children:(0,t.jsxs)("div",{className:"flex items-center gap-6",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("span",{className:"text-sm",children:"Urun Eslestirme"}),(0,t.jsxs)("span",{className:"text-sm font-medium",children:[eS,"%"]})]}),(0,t.jsx)(U.Progress,{value:eS,className:"h-2"})]}),(0,t.jsxs)("div",{className:"flex gap-4 text-sm",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(M.CheckCircle,{className:"h-4 w-4 text-green-500"}),(0,t.jsxs)("span",{children:[ev," Eslesti"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(O.AlertTriangle,{className:"h-4 w-4 text-yellow-500"}),(0,t.jsxs)("span",{children:[ey," Oneri"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(B.XCircle,{className:"h-4 w-4 text-red-500"}),(0,t.jsxs)("span",{children:[eC," Eslesmedi"]})]})]}),(0,t.jsxs)(v.Button,{variant:"outline",size:"sm",onClick:ej,children:[(0,t.jsx)(x.RefreshCw,{className:"h-4 w-4 mr-1"}),"Yeniden Esle"]})]})})}),(0,t.jsxs)(b.Card,{children:[(0,t.jsx)(b.CardHeader,{className:"pb-2",children:(0,t.jsxs)(b.CardTitle,{className:"text-sm",children:["Fatura Kalemleri (",u.length,")"]})}),(0,t.jsx)(b.CardContent,{children:(0,t.jsx)("div",{className:"max-h-[300px] overflow-y-auto",children:(0,t.jsxs)(S.Table,{children:[(0,t.jsx)(S.TableHeader,{children:(0,t.jsxs)(S.TableRow,{children:[(0,t.jsx)(S.TableHead,{className:"w-[30px]"}),(0,t.jsx)(S.TableHead,{className:"w-[40px]",children:"#"}),(0,t.jsx)(S.TableHead,{children:"Tedarikci Kodu"}),(0,t.jsx)(S.TableHead,{children:"Bizim Sifra"}),(0,t.jsx)(S.TableHead,{children:"Urun Adi"}),(0,t.jsx)(S.TableHead,{className:"text-right",children:"Miktar"}),(0,t.jsx)(S.TableHead,{children:"Birim"}),(0,t.jsx)(S.TableHead,{className:"text-right",children:"Fiyat"}),(0,t.jsx)(S.TableHead,{className:"text-right",children:"Toplam"}),(0,t.jsx)(S.TableHead,{children:"Eslesen Urun"})]})}),(0,t.jsx)(S.TableBody,{children:u.map(e=>(0,t.jsxs)(S.TableRow,{className:"matched"===e.matchStatus?"bg-green-50":"suggested"===e.matchStatus?"bg-yellow-50":"bg-red-50",children:[(0,t.jsxs)(S.TableCell,{children:["matched"===e.matchStatus&&(0,t.jsx)(M.CheckCircle,{className:"h-4 w-4 text-green-500"}),"suggested"===e.matchStatus&&(0,t.jsx)(O.AlertTriangle,{className:"h-4 w-4 text-yellow-500"}),"unmatched"===e.matchStatus&&(0,t.jsx)(B.XCircle,{className:"h-4 w-4 text-red-500"})]}),(0,t.jsx)(S.TableCell,{className:"text-xs text-muted-foreground",children:e.rowNumber}),(0,t.jsx)(S.TableCell,{className:"font-mono text-xs",children:e.supplierCode||"-"}),(0,t.jsx)(S.TableCell,{className:"font-mono text-xs",children:e.ourCode||"-"}),(0,t.jsx)(S.TableCell,{className:"max-w-[150px] truncate",children:e.productName}),(0,t.jsx)(S.TableCell,{className:"text-right",children:e.quantity}),(0,t.jsx)(S.TableCell,{children:e.unit}),(0,t.jsx)(S.TableCell,{className:"text-right font-mono",children:e.unitPrice.toFixed(2)}),(0,t.jsx)(S.TableCell,{className:"text-right font-mono font-medium",children:e.lineTotal.toFixed(2)}),(0,t.jsx)(S.TableCell,{children:(0,t.jsxs)(C.Select,{value:e.matchedProductId||"none",onValueChange:t=>{var a,s;let l,r;return a=e.id,l="none"===(s="none"===t?"":t)?"":s,r=eo.find(e=>e.id===l),void m(u.map(e=>e.id!==a?e:{...e,matchedProductId:l||void 0,matchedProductName:r?.name||"",matchStatus:l?"matched":"unmatched"}))},children:[(0,t.jsx)(C.SelectTrigger,{className:"h-8 text-xs",children:(0,t.jsx)(C.SelectValue,{placeholder:"Urun sec..."})}),(0,t.jsxs)(C.SelectContent,{children:[(0,t.jsx)(C.SelectItem,{value:"none",children:"-- Secim yok --"}),eo.filter(e=>e.id).map(e=>(0,t.jsx)(C.SelectItem,{value:e.id,children:e.name},e.id))]})]})})]},e.id))})]})})})]}),(0,t.jsxs)(b.Card,{children:[(0,t.jsx)(b.CardHeader,{className:"pb-2",children:(0,t.jsx)(b.CardTitle,{className:"text-sm",children:"Ek Masraflar"})}),(0,t.jsx)(b.CardContent,{children:(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(D.Label,{className:"flex items-center gap-2",children:[(0,t.jsx)(H.Truck,{className:"h-4 w-4"}),"Nakliye (EUR)"]}),(0,t.jsx)(y.Input,{type:"number",value:Q,onChange:e=>J(parseFloat(e.target.value)||0),min:"0",step:"0.01"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(D.Label,{className:"flex items-center gap-2",children:[(0,t.jsx)(K.Package,{className:"h-4 w-4"}),"Gumruk (EUR)"]}),(0,t.jsx)(y.Input,{type:"number",value:ee,onChange:e=>et(parseFloat(e.target.value)||0),min:"0",step:"0.01"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(D.Label,{children:"Diger Masraflar (EUR)"}),(0,t.jsx)(y.Input,{type:"number",value:ea,onChange:e=>es(parseFloat(e.target.value)||0),min:"0",step:"0.01"})]})]})})]}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsxs)("div",{className:"w-72 space-y-1 text-sm",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Ara Toplam (KDV Haric):"}),(0,t.jsxs)("span",{className:"font-mono",children:[ef.toFixed(2)," EUR"]})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"KDV Toplam:"}),(0,t.jsxs)("span",{className:"font-mono",children:[eg.toFixed(2)," EUR"]})]}),eN>0&&(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Ek Masraflar:"}),(0,t.jsxs)("span",{className:"font-mono",children:["+",eN.toFixed(2)," EUR"]})]}),(0,t.jsxs)("div",{className:"flex justify-between font-medium border-t pt-1 text-lg",children:[(0,t.jsx)("span",{children:"Genel Toplam:"}),(0,t.jsxs)("span",{className:"font-mono text-primary",children:[eb.toFixed(2)," EUR"]})]})]})}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)(v.Button,{variant:"outline",onClick:()=>i("upload"),children:"Geri"}),(0,t.jsx)(v.Button,{onClick:eT,disabled:A,children:A?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.RefreshCw,{className:"h-4 w-4 mr-2 animate-spin"}),"Kaydediliyor..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(M.CheckCircle,{className:"h-4 w-4 mr-2"}),"Fatura Olustur"]})})]})]})]})})}let W={draft:{label:"Taslak",color:"bg-gray-100 text-gray-700"},pending:{label:"Beklemede",color:"bg-yellow-100 text-yellow-700"},approved:{label:"Onaylandƒ±",color:"bg-emerald-100 text-emerald-700"},cancelled:{label:"ƒ∞ptal",color:"bg-red-100 text-red-700"}},Q={unpaid:{label:"√ñdenmedi",color:"bg-red-100 text-red-700"},partial:{label:"Kƒ±smi √ñdeme",color:"bg-yellow-100 text-yellow-700"},paid:{label:"√ñdendi",color:"bg-emerald-100 text-emerald-700"}};function J(){let[e,j]=(0,a.useState)([]),[D,I]=(0,a.useState)([]),[_,A]=(0,a.useState)(!0),[F,P]=(0,a.useState)(""),[R,M]=(0,a.useState)("all"),[B,O]=(0,a.useState)("all"),[H,K]=(0,a.useState)(!1),[U,q]=(0,a.useState)(null),[V,G]=(0,a.useState)(!1),[$,X]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let e=(0,k.subscribeToFirestore)("purchases",e=>{e?j([...e].sort((e,t)=>{let a=new Date(e.date||e.invoice_date||e.createdAt||e.created_at||"").getTime();return new Date(t.date||t.invoice_date||t.createdAt||t.created_at||"").getTime()-a})):j([]),A(!1)}),t=(0,k.subscribeToBranches)(e=>{I(e||[])});return()=>{e(),t()}},[]);let Z=(0,a.useMemo)(()=>e.filter(e=>{let t=e.invoiceNo||e.invoice_number||"",a=e.supplier||e.supplier_name||"",s=e.branchId||e.branch_id||"",l=t.toLowerCase().includes(F.toLowerCase())||a.toLowerCase().includes(F.toLowerCase()),r="all"===R||e.status===R,n="all"===B||s===B;return l&&r&&n}),[e,F,R,B]),J=(0,a.useMemo)(()=>{let t=e.length,a=e.reduce((e,t)=>e+(t.total||t.grand_total||0),0),s=e.filter(e=>"unpaid"===e.paymentStatus||"pending"===e.status).length,l=e.filter(e=>"unpaid"===e.paymentStatus||"pending"===e.status).reduce((e,t)=>e+(t.total||t.grand_total||0),0);return{total:t,totalAmount:a,unpaid:s,unpaidAmount:l,paidCount:e.filter(e=>"paid"===e.paymentStatus||"paid"===e.status).length,paidAmount:e.filter(e=>"paid"===e.paymentStatus||"paid"===e.status).reduce((e,t)=>e+(t.total||t.grand_total||0),0)}},[e]),ee=e=>{q(e),K(!0)},et=async e=>{let t=e.invoiceNo||e.invoice_number||e.id;if(confirm(`"${t}" faturasini silmek istediginize emin misiniz?`))try{await (0,k.deleteFirestoreData)("purchases",e.id),E.toast.success("Fatura silindi")}catch(e){E.toast.error("Silme hatasi: "+e.message)}};return _?(0,t.jsxs)("div",{className:"flex items-center justify-center h-96",children:[(0,t.jsx)(u.Loader2,{className:"h-8 w-8 animate-spin text-primary"}),(0,t.jsx)("span",{className:"ml-2 text-muted-foreground",children:"Y√ºkleniyor..."})]}):(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)("div",{className:"flex flex-col gap-4",children:(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl lg:text-3xl font-bold tracking-tight",children:"Alƒ±≈ü Faturalarƒ±"}),(0,t.jsx)("p",{className:"text-muted-foreground text-sm lg:text-base",children:"Tedarik√ßilerden alƒ±nan faturalar"})]}),(0,t.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,t.jsxs)(v.Button,{variant:"outline",size:"sm",onClick:()=>{A(!0),setTimeout(()=>A(!1),500)},className:"flex-1 sm:flex-none",children:[(0,t.jsx)(x.RefreshCw,{className:`h-4 w-4 mr-2 ${_?"animate-spin":""}`}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Yenile"})]}),(0,t.jsxs)(T.DropdownMenu,{children:[(0,t.jsx)(T.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsxs)(v.Button,{variant:"outline",size:"sm",className:"flex-1 sm:flex-none",children:[(0,t.jsx)(N,{className:"h-4 w-4 sm:mr-2"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"ƒ∞√ße Aktar"})]})}),(0,t.jsxs)(T.DropdownMenuContent,{align:"end",children:[(0,t.jsxs)(T.DropdownMenuItem,{onClick:()=>G(!0),children:[(0,t.jsx)(f,{className:"h-4 w-4 mr-2"}),"XML Fatura (e-Fatura)"]}),(0,t.jsxs)(T.DropdownMenuItem,{onClick:()=>X(!0),children:[(0,t.jsx)(g.FileSpreadsheet,{className:"h-4 w-4 mr-2"}),"Excel Dosyasƒ±"]})]})]}),(0,t.jsxs)(v.Button,{variant:"outline",size:"sm",className:"hidden md:flex",children:[(0,t.jsx)(o.Download,{className:"h-4 w-4 mr-2"}),"Dƒ±≈üa Aktar"]}),(0,t.jsxs)(v.Button,{size:"sm",onClick:()=>{q(null),K(!0)},className:"flex-1 sm:flex-none",children:[(0,t.jsx)(s.Plus,{className:"h-4 w-4 mr-2"}),"Yeni Fatura"]})]})]})}),(0,t.jsxs)("div",{className:"grid gap-3 lg:gap-4 grid-cols-2 lg:grid-cols-4",children:[(0,t.jsxs)(b.Card,{children:[(0,t.jsxs)(b.CardHeader,{className:"flex flex-row items-center justify-between pb-2",children:[(0,t.jsx)(b.CardTitle,{className:"text-sm font-medium text-muted-foreground",children:"Toplam Fatura"}),(0,t.jsx)(m.FileText,{className:"h-4 w-4 text-muted-foreground"})]}),(0,t.jsx)(b.CardContent,{children:(0,t.jsx)("div",{className:"text-2xl font-bold",children:J.total})})]}),(0,t.jsxs)(b.Card,{children:[(0,t.jsxs)(b.CardHeader,{className:"flex flex-row items-center justify-between pb-2",children:[(0,t.jsx)(b.CardTitle,{className:"text-sm font-medium text-muted-foreground",children:"Toplam Tutar"}),(0,t.jsx)(n.Building2,{className:"h-4 w-4 text-muted-foreground"})]}),(0,t.jsx)(b.CardContent,{children:(0,t.jsx)("div",{className:"text-2xl font-bold text-primary",children:(0,w.formatCurrency)(J.totalAmount)})})]}),(0,t.jsxs)(b.Card,{children:[(0,t.jsxs)(b.CardHeader,{className:"flex flex-row items-center justify-between pb-2",children:[(0,t.jsx)(b.CardTitle,{className:"text-sm font-medium text-muted-foreground",children:"√ñdenmemi≈ü"}),(0,t.jsx)("div",{className:"h-2 w-2 rounded-full bg-red-500"})]}),(0,t.jsx)(b.CardContent,{children:(0,t.jsx)("div",{className:"text-2xl font-bold text-red-600",children:J.unpaid})})]}),(0,t.jsxs)(b.Card,{children:[(0,t.jsxs)(b.CardHeader,{className:"flex flex-row items-center justify-between pb-2",children:[(0,t.jsx)(b.CardTitle,{className:"text-sm font-medium text-muted-foreground",children:"√ñdenmemi≈ü Tutar"}),(0,t.jsx)(r.ShoppingCart,{className:"h-4 w-4 text-muted-foreground"})]}),(0,t.jsx)(b.CardContent,{children:(0,t.jsx)("div",{className:"text-2xl font-bold text-red-600",children:(0,w.formatCurrency)(J.unpaidAmount)})})]})]}),(0,t.jsx)(b.Card,{children:(0,t.jsx)(b.CardContent,{className:"pt-6",children:(0,t.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-3",children:[(0,t.jsxs)("div",{className:"relative flex-1",children:[(0,t.jsx)(l.Search,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),(0,t.jsx)(y.Input,{type:"search",placeholder:"Fatura no veya tedarikci ara...",value:F,onChange:e=>P(e.target.value),className:"pl-9"})]}),(0,t.jsxs)(C.Select,{value:B,onValueChange:O,children:[(0,t.jsxs)(C.SelectTrigger,{className:"w-full sm:w-[180px]",children:[(0,t.jsx)(h.Store,{className:"h-4 w-4 mr-2"}),(0,t.jsx)(C.SelectValue,{placeholder:"Sube"})]}),(0,t.jsxs)(C.SelectContent,{children:[(0,t.jsx)(C.SelectItem,{value:"all",children:"Tum Subeler"}),D.filter(e=>e.id&&!1!==e.isActive).map(e=>(0,t.jsx)(C.SelectItem,{value:e.id,children:e.name},e.id))]})]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,t.jsx)(v.Button,{variant:"all"===R?"default":"outline",size:"sm",onClick:()=>M("all"),children:"Tumu"}),Object.entries(W).map(([e,{label:a}])=>(0,t.jsx)(v.Button,{variant:R===e?"default":"outline",size:"sm",onClick:()=>M(e),children:a},e))]})]})})}),(0,t.jsx)(b.Card,{children:(0,t.jsx)(b.CardContent,{className:"pt-6 overflow-x-auto",children:(0,t.jsxs)(S.Table,{className:"min-w-[900px]",children:[(0,t.jsx)(S.TableHeader,{children:(0,t.jsxs)(S.TableRow,{children:[(0,t.jsx)(S.TableHead,{children:"Fatura No"}),(0,t.jsx)(S.TableHead,{children:"Tarih"}),(0,t.jsx)(S.TableHead,{children:"Tedarikci"}),(0,t.jsx)(S.TableHead,{className:"hidden lg:table-cell",children:"Sube"}),(0,t.jsx)(S.TableHead,{className:"text-right hidden md:table-cell",children:"Ara Toplam"}),(0,t.jsx)(S.TableHead,{className:"text-right hidden sm:table-cell",children:"KDV"}),(0,t.jsx)(S.TableHead,{className:"text-right",children:"Toplam"}),(0,t.jsx)(S.TableHead,{className:"hidden sm:table-cell",children:"Durum"}),(0,t.jsx)(S.TableHead,{children:"Odeme"}),(0,t.jsx)(S.TableHead,{className:"w-[100px]",children:"Islem"})]})}),(0,t.jsx)(S.TableBody,{children:0===Z.length?(0,t.jsx)(S.TableRow,{children:(0,t.jsxs)(S.TableCell,{colSpan:10,className:"text-center py-12",children:[(0,t.jsx)(r.ShoppingCart,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),(0,t.jsx)("h3",{className:"text-lg font-medium",children:"Fatura bulunamadi"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Henuz alis faturasi eklenmemis veya arama kriterlerine uygun sonuc yok."})]})}):Z.slice(0,100).map(e=>(0,t.jsxs)(S.TableRow,{children:[(0,t.jsx)(S.TableCell,{className:"font-medium font-mono",children:e.invoiceNo||e.invoice_number||"-"}),(0,t.jsx)(S.TableCell,{children:(0,w.formatDate)(e.date||e.invoice_date||e.createdAt||new Date)}),(0,t.jsx)(S.TableCell,{children:e.supplier||e.supplier_name||"-"}),(0,t.jsx)(S.TableCell,{className:"hidden lg:table-cell",children:(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:(e=>{if(!e)return"-";let t=D.find(t=>t.id===e);return t?.name||e})(e.branchId||e.branch_id)})}),(0,t.jsx)(S.TableCell,{className:"text-right font-mono hidden md:table-cell",children:(0,w.formatCurrency)(e.subtotal||0)}),(0,t.jsx)(S.TableCell,{className:"text-right font-mono text-muted-foreground hidden sm:table-cell",children:(0,w.formatCurrency)(e.vatAmount||e.total_tax||0)}),(0,t.jsx)(S.TableCell,{className:"text-right font-mono font-medium",children:(0,w.formatCurrency)(e.total||e.grand_total||0)}),(0,t.jsx)(S.TableCell,{className:"hidden sm:table-cell",children:(0,t.jsx)("span",{className:`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${W[e.status||"pending"]?.color||"bg-gray-100"}`,children:W[e.status||"pending"]?.label||e.status||"Beklemede"})}),(0,t.jsx)(S.TableCell,{children:(0,t.jsx)("span",{className:`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${Q[e.paymentStatus||"unpaid"]?.color||"bg-gray-100"}`,children:Q[e.paymentStatus||"unpaid"]?.label||e.paymentStatus||"Odenmedi"})}),(0,t.jsx)(S.TableCell,{children:(0,t.jsxs)(T.DropdownMenu,{children:[(0,t.jsx)(T.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(v.Button,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,t.jsx)(c.Eye,{className:"h-4 w-4"})})}),(0,t.jsxs)(T.DropdownMenuContent,{align:"end",children:[(0,t.jsxs)(T.DropdownMenuItem,{onClick:()=>ee(e),children:[(0,t.jsx)(c.Eye,{className:"h-4 w-4 mr-2"}),"Goruntule"]}),(0,t.jsxs)(T.DropdownMenuItem,{onClick:()=>ee(e),children:[(0,t.jsx)(i.Edit,{className:"h-4 w-4 mr-2"}),"Duzenle"]}),(0,t.jsxs)(T.DropdownMenuItem,{children:[(0,t.jsx)(p.Printer,{className:"h-4 w-4 mr-2"}),"Yazdir"]}),(0,t.jsx)(T.DropdownMenuSeparator,{}),(0,t.jsxs)(T.DropdownMenuItem,{className:"text-destructive",onClick:()=>et(e),children:[(0,t.jsx)(d.Trash2,{className:"h-4 w-4 mr-2"}),"Sil"]})]})]})})]},e.id))})]})})}),(0,t.jsx)(L,{open:H,onOpenChange:K,invoice:U}),(0,t.jsx)(z,{open:V,onOpenChange:G}),(0,t.jsx)(Y,{open:$,onOpenChange:X})]})}e.s(["default",()=>J],43413)}]);